{% extends 'base.html' %}
{% block title %}Новая карточка ученика{% endblock %}
{% block content %}
<div class="form-page">
  <div class="form-container">
    <div class="form-card">
      <div class="form-card__body">
        <h1 class="form-title">{% if student %}Редактирование карточки{% else %}Новая карточка ученика{% endif %}</h1>

        {% if error_message %}
          <div class="alert error">{{ error_message }}</div>
        {% endif %}

        {% if similar_students %}
          <div class="alert alert-warning">
            <h5>Возможное дублирование найдено:</h5>
            <ul>
              {% for student in similar_students %}
                <li><strong>{{ student.full_name }}</strong> - {{ student.class_name }} (кл. {{ student.class_teacher }})</li>
              {% endfor %}
            </ul>
            <p>Если это не дублирование, продолжите создание. В противном случае отмените и проверьте существующего ученика.</p>
          </div>
        {% endif %}

        <form method="post" class="form-grid">
          <div class="form-group">
            <label class="form-label">ФИО *</label>
            <input type="text" name="full_name" class="form-input" value="{{ (student.full_name if student) or (form_data.full_name if form_data) }}" required>
          </div>
          <div class="form-group">
            <label class="form-label">Класс *</label>
            <select name="school_class_id" class="form-input" required>
              <option value="">Выберите класс...</option>
              {% for grade in grades %}
                <optgroup label="{{ grade.grade_name }}">
                  {% for school_class in grade.classes %}
                    <option value="{{ school_class.id }}"
                            {% if (student and student.school_class_id == school_class.id) or (selected_class and selected_class.id == school_class.id) or (form_data and form_data.school_class_id == school_class.id|string) %}selected{% endif %}>
                      {{ school_class.class_name }}
                      {% if school_class.class_teacher %}
                        ({{ school_class.class_teacher.username }})
                      {% else %}
                        (без руководителя)
                      {% endif %}
                    </option>
                  {% endfor %}
                </optgroup>
              {% endfor %}
            </select>
          </div>
          <div class="form-group form-group--full">
            <label class="form-label">Достижения</label>
            {% set achs = [] %}
            {% if student and student.achievements %}
              {% set achs = student.achievements|from_json %}
            {% endif %}
            <div id="achievements-list" class="achievements-form-list">
              {% if achs and achs|length > 0 %}
                {% for ach in achs %}
                  <div class="achievement-item">
                    <input type="text" name="ach_title[]" class="form-input achievement-title" placeholder="Название конкурса" value="{{ ach.title if ach.title }}" required>
                    <select name="ach_level[]" class="form-input achievement-select" required>
                      <option value="">Уровень…</option>
                      <option value="school" {% if ach.level=="school" %}selected{% endif %}>Школьный</option>
                      <option value="district" {% if ach.level=="district" %}selected{% endif %}>Районный</option>
                      <option value="region" {% if ach.level=="region" %}selected{% endif %}>Региональный</option>
                      <option value="russia" {% if ach.level=="russia" %}selected{% endif %}>Россия</option>
                      <option value="world" {% if ach.level=="world" %}selected{% endif %}>Международный</option>
                    </select>
                    <select name="ach_result[]" class="form-input achievement-select" required>
                      <option value="">Результат…</option>
                      <option value="participant" {% if ach.result=="participant" %}selected{% endif %}>Участник</option>
                      <option value="winner" {% if ach.result=="winner" %}selected{% endif %}>Победитель</option>
                      <option value="prize" {% if ach.result=="prize" %}selected{% endif %}>Призёр</option>
                    </select>
                    <select name="ach_year[]" class="form-input achievement-select" required>
                      <option value="">Год…</option>
                      {% for y in range(2023, 2040) %}
                        <option value="{{ (y|string)[2:] }}/{{ ((y+1)|string)[2:] }}" {% if ach.year==((y|string)[2:] + '/' + ((y+1)|string)[2:]) %}selected{% endif %}>{{ (y|string)[2:] }}/{{ ((y+1)|string)[2:] }}</option>
                      {% endfor %}
                    </select>
                    <input type="date" name="ach_date[]" class="form-input achievement-date" value="{{ ach.date }}" required>
                    <button type="button" class="btn btn-outline-danger btn-sm achievement-remove" onclick="removeAchievement(this)">Удалить</button>
                  </div>
                {% endfor %}
              {% else %}
                <div class="achievement-item">
                  <input type="text" name="ach_title[]" class="form-input achievement-title" placeholder="Название конкурса" required>
                  <select name="ach_level[]" class="form-input achievement-select" required>
                    <option value="">Уровень…</option>
                    <option value="school">Школьный</option>
                    <option value="district">Районный</option>
                    <option value="region">Региональный</option>
                    <option value="russia">Россия</option>
                    <option value="world">Международный</option>
                  </select>
                  <select name="ach_result[]" class="form-input achievement-select" required>
                    <option value="">Результат…</option>
                    <option value="participant">Участник</option>
                    <option value="winner">Победитель</option>
                    <option value="prize">Призёр</option>
                  </select>
                  <select name="ach_year[]" class="form-input achievement-select" required>
                    <option value="">Год…</option>
                    {% for y in range(2023, 2040) %}
                      <option value="{{ (y|string)[2:] }}/{{ ((y+1)|string)[2:] }}">{{ (y|string)[2:] }}/{{ ((y+1)|string)[2:] }}</option>
                    {% endfor %}
                  </select>
                  <input type="date" name="ach_date[]" class="form-input achievement-date" required>
                  <button type="button" class="btn btn-outline-danger btn-sm achievement-remove" onclick="removeAchievement(this)">Удалить</button>
                </div>
              {% endif %}
            </div>
            <button type="button" class="btn btn-outline-primary btn-sm achievement-add" onclick="addAchievement()">Добавить достижение</button>
          </div>
          <script>
          function addAchievement() {
            const container = document.getElementById('achievements-list');
            const item = document.createElement('div');
            item.className = 'achievement-item';
            item.innerHTML = `
              <input type="text" name="ach_title[]" class="form-input achievement-title" placeholder="Название конкурса" required>
              <select name="ach_level[]" class="form-input achievement-select" required>
                <option value="">Уровень…</option>
                <option value="school">Школьный</option>
                <option value="district">Районный</option>
                <option value="region">Региональный</option>
                <option value="russia">Россия</option>
                <option value="world">Международный</option>
              </select>
              <select name="ach_result[]" class="form-input achievement-select" required>
                <option value="">Результат…</option>
                <option value="participant">Участник</option>
                <option value="winner">Победитель</option>
                <option value="prize">Призёр</option>
              </select>
              <select name="ach_year[]" class="form-input achievement-select" required>
                <option value="">Год…</option>
                ${(() => {
                  let s = '';
                  for (let y = 2023; y < 2040; y++) {
                    const val = String(y).slice(2) + '/' + String(y + 1).slice(2);
                    s += `<option value="${val}">${val}</option>`;
                  }
                  return s;
                })()}
              </select>
              <input type="date" name="ach_date[]" class="form-input achievement-date" required>
              <button type="button" class="btn btn-outline-danger btn-sm achievement-remove" onclick="removeAchievement(this)">Удалить</button>
            `;
            container.appendChild(item);
          }
          function removeAchievement(btn) {
            const item = btn.closest('.achievement-item');
            const container = document.getElementById('achievements-list');
            if (container.children.length > 1) {
              item.remove();
            } else {
              // Очистить все поля в item
              item.querySelectorAll('input, select').forEach(f => { f.value = ''; });
            }
          }
          </script>
          <div class="form-actions">
            <button class="btn btn-primary" type="submit">Сохранить</button>
            <a class="btn btn-secondary" href="{{ url_for('admin_dashboard') }}">Отмена</a>
            {% if student %}
              <button class="btn btn-danger" formmethod="post" formaction="{{ url_for('admin_student_delete', student_id=student.id) }}" onclick="return confirm('Удалить карточку {{ student.full_name }}?');">Удалить</button>
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
 </div>
{% endblock %}


