{% extends 'base.html' %}
{% block title %}{% if school_class %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞{% else %}–ù–æ–≤—ã–π –∫–ª–∞—Å—Å{% endif %}{% endblock %}
{% block content %}
<div class="form-page">
  <div class="form-container">
    <div class="form-card">
      <div class="form-card__body">
        <h1 class="form-title">{% if school_class %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞{% else %}–ù–æ–≤—ã–π –∫–ª–∞—Å—Å{% endif %}</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'warning' }}">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form id="main-form" method="post" class="form-grid" onsubmit="return validateClassForm()">
          {% if not school_class %}
          <div class="form-group">
            <label class="form-label">–ü–∞—Ä–∞–ª–ª–µ–ª—å *</label>
            <select name="grade_id" class="form-input" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å...</option>
              {% for grade in grades %}
                <option value="{{ grade.id }}">{{ grade.grade_name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">–ë—É–∫–≤–∞ –∫–ª–∞—Å—Å–∞ *</label>
            <select name="class_letter" class="form-input" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—É–∫–≤—É...</option>
              <option value="–ê">–ê</option>
              <option value="–ë">–ë</option>
              <option value="–í">–í</option>
              <option value="–ì">–ì</option>
              <option value="–î">–î</option>
              <option value="–ï">–ï</option>
              <option value="–ñ">–ñ</option>
              <option value="–ó">–ó</option>
              <option value="–ò">–ò</option>
              <option value="–ö">–ö</option>
              <option value="–õ">–õ</option>
              <option value="–ú">–ú</option>
              <option value="–ù">–ù</option>
              <option value="–û">–û</option>
              <option value="–ü">–ü</option>
              <option value="–†">–†</option>
              <option value="–°">–°</option>
              <option value="–¢">–¢</option>
              <option value="–£">–£</option>
              <option value="–§">–§</option>
              <option value="–•">–•</option>
              <option value="–¶">–¶</option>
              <option value="–ß">–ß</option>
              <option value="–®">–®</option>
              <option value="–©">–©</option>
              <option value="–≠">–≠</option>
              <option value="–Æ">–Æ</option>
              <option value="–Ø">–Ø</option>
            </select>
          </div>
          {% else %}
          <div class="form-group form-group--full">
            <label class="form-label">–ö–ª–∞—Å—Å</label>
            <input type="text" class="form-input" value="{{ school_class.class_name }}" readonly>
            <small class="form-text text-muted">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –Ω–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å</small>
          </div>
          {% endif %}

          <div class="form-group form-group--full">
            <label class="form-label">–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</label>
            <select name="class_teacher_id" class="form-input">
              <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
              {% for teacher in teachers %}
                {% if teacher.role in ['class_teacher', 'teacher', 'deputy'] %}
                <option value="{{ teacher.id }}"
                        {% if school_class and school_class.class_teacher_id == teacher.id %}selected{% endif %}>
                  {{ teacher.username }} ({{ user_roles[teacher.role]['name'] }})
                </option>
                {% endif %}
              {% endfor %}
            </select>
            <small class="form-text text-muted">
              –ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ä–æ–ª—å "–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å", "–£—á–∏—Ç–µ–ª—å" –∏–ª–∏ "–ó–∞–≤—É—á"
            </small>
          </div>
        </form>

        <div class="form-actions">
          <button class="btn btn-primary" type="submit" form="main-form">
            {% if school_class %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å{% endif %}
          </button>
          {% if school_class %}
          <form method="post" action="{{ url_for('admin_class_delete', class_id=school_class.id) }}" style="display: inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Å {{ school_class.class_name }}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')">
            <button type="submit" class="btn btn-outline-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Å</button>
          </form>
          {% endif %}
          <a class="btn btn-secondary" href="{{ url_for('admin_classes') }}">–û—Ç–º–µ–Ω–∞</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
const existingClasses = [
{% for grade in grades %}
  {% for school_class in grade.classes %}
    '{{ school_class.class_name }}',
  {% endfor %}
{% endfor %}
];

function validateClassForm() {
    {% if not school_class %}
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞
    const gradeSelect = document.querySelector('select[name="grade_id"]');
    const letterSelect = document.querySelector('select[name="class_letter"]');

    if (gradeSelect && letterSelect) {
        const gradeId = gradeSelect.value;
        const letter = letterSelect.value;

        if (gradeId && letter) {
            // –ù–∞—Ö–æ–¥–∏–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞—Ä–∞–ª–ª–µ–ª—å
            const selectedGrade = {{ grades|tojson }}.find(g => g.id == gradeId);
            if (selectedGrade) {
                const fullClassName = selectedGrade.grade_number + letter;

                if (existingClasses.includes(fullClassName)) {
                    alert(`–ö–ª–∞—Å—Å ${fullClassName} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç! –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –±—É–∫–≤—É –∏–ª–∏ —É–¥–∞–ª–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å.`);
                    return false;
                }
            }
        }
    }
    {% endif %}

    return true;
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
{% if not school_class %}
document.addEventListener('DOMContentLoaded', function() {
    const letterSelect = document.querySelector('select[name="class_letter"]');
    const gradeSelect = document.querySelector('select[name="grade_id"]');

    function checkDuplicate() {
        const gradeId = gradeSelect.value;
        const letter = letterSelect.value;

        if (gradeId && letter) {
            const selectedGrade = {{ grades|tojson }}.find(g => g.id == gradeId);
            if (selectedGrade) {
                const fullClassName = selectedGrade.grade_number + letter;
                const warningDiv = document.getElementById('duplicate-warning');

                if (existingClasses.includes(fullClassName)) {
                    if (!warningDiv) {
                        const warning = document.createElement('div');
                        warning.id = 'duplicate-warning';
                        warning.className = 'alert alert-warning';
                        warning.innerHTML = `<strong>–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ:</strong> –ö–ª–∞—Å—Å ${fullClassName} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!`;
                        const form = document.getElementById('main-form');
                        form.parentNode.insertBefore(warning, form);
                    }
                } else {
                    if (warningDiv) {
                        warningDiv.remove();
                    }
                }
            }
        }
    }

    if (letterSelect && gradeSelect) {
        letterSelect.addEventListener('change', checkDuplicate);
        gradeSelect.addEventListener('change', checkDuplicate);
    }
});
{% endif %}
</script>
{% endblock %}