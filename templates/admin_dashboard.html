{% extends 'base.html' %}
{% block title %}Админ — Ученики{% endblock %}
{% block content %}
<div class="admin-toolbar card">
  <div class="admin-toolbar__row">
    <div class="admin-toolbar__left">
      <h1 class="page-title mb-0">Ученики</h1>
    </div>
    <div class="admin-toolbar__right">
      <a class="btn btn-primary" href="{{ url_for('admin_student_new') }}">Новая карточка</a>
      <a class="btn btn-success" href="{{ url_for('admin_export_excel') }}">Экспорт всех</a>
      <div class="dropdown">
        <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          Экспорт класса
        </button>
        <ul class="dropdown-menu">
          {% for c in classes %}
            <li><a class="dropdown-item" href="{{ url_for('admin_export_excel_class') }}?class={{ c }}">{{ c }}</a></li>
          {% endfor %}
        </ul>
      </div>
      <a class="btn btn-secondary" href="{{ url_for('admin_logout') }}">Выйти</a>
    </div>
  </div>
</div>

<form method="get" class="filters">
  <div class="filters__group">
    <label class="filters__label">Поиск (ФИО)</label>
    <input class="filters__input" type="text" name="q" value="{{ q }}" placeholder="например Иванов">
  </div>
  <div class="filters__group">
    <label class="filters__label">Класс</label>
    <select class="filters__input" name="class">
      <option value="">Все</option>
      {% for c in classes %}
        <option value="{{ c }}" {% if class_name==c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filters__group">
    <label class="filters__label">Сортировка</label>
    <select class="filters__input" name="order">
      <option value="">Новые сверху</option>
      <option value="class" {% if order=='class' %}selected{% endif %}>По классу</option>
      <option value="teacher" {% if order=='teacher' %}selected{% endif %}>По кл. руководителю</option>
    </select>
  </div>
  <div class="filters__actions">
    <button class="btn btn-primary filters__button" type="submit">Применить</button>
  </div>
 </form>

<div class="table-responsive card">
  <table class="table table-sm mb-0">
    <thead>
      <tr>
        <th>#</th>
        <th>ФИО</th>
        <th>Класс</th>
        <th>Кл. руководитель</th>
        <th>Достижения</th>
        <th>Создано</th>
      </tr>
    </thead>
    <tbody>
      {% for s in students %}
      <tr>
        <td>{{ s.id }}</td>
        <td>
          <div class="student-name">{{ s.full_name }}</div>
          <div class="row-actions">
            <a class="btn btn-small btn-secondary" href="{{ url_for('admin_student_edit', student_id=s.id) }}">Редактировать</a>
            <form method="post" action="{{ url_for('admin_student_delete', student_id=s.id) }}" style="display:inline" onsubmit="return confirm('Удалить карточку {{ s.full_name }}?');">
              <button type="submit" class="btn btn-small btn-danger">Удалить</button>
            </form>
          </div>
        </td>
        <td>{{ s.class_name }}</td>
        <td>{{ s.class_teacher }}</td>
        <td>
          {% set achs = s.achievements | from_json %}
          {% if achs and achs|length > 0 and achs[0]['title'] is defined %}
          <table class="mini-ach-table">
            <thead><tr><th>Конкурс</th><th>Уровень</th><th>Результат</th><th>Год</th><th>Дата</th></tr></thead>
            <tbody>
              {% for ach in achs %}
                <tr>
                  <td>{{ ach.title }}</td>
                  <td>{% if ach.level=='school' %}Школьный{% elif ach.level=='district' %}Районный{% elif ach.level=='region' %}Региональный{% elif ach.level=='russia' %}Россия{% elif ach.level=='world' %}Международный{% else %}{{ ach.level }}{% endif %}</td>
                  <td>{% if ach.result=='participant' %}Участник{% elif ach.result=='prize' %}Призёр{% elif ach.result=='winner' %}Победитель{% else %}{{ ach.result }}{% endif %}</td>
                  <td>{{ ach.year }}</td>
                  <td>{{ ach.date }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          {% elif s.achievements %}
            <div>{{ s.achievements }}</div>
          {% endif %}
        </td>
        <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M') if s.created_at else '' }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="6" class="text-center text-muted">Нет записей</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
 </div>
{% endblock %}


